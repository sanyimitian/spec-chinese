---
description: 通过最多 5 个高度聚焦的问题识别当前功能规范的欠说明之处，并将答案写回规范。
handoffs: 
  - label: 构建技术计划
    agent: speckit.plan
    prompt: 为规范创建计划。我使用的技术栈是...
---

## 用户输入

```text
$ARGUMENTS
```

在继续之前你**必须**先考虑用户输入（如果不为空）。

## 大纲

目标：检测并降低当前功能规范中的歧义或缺失决策点，并将澄清直接记录到规范文件。

注意：该澄清流程应在调用 `/speckit.plan` **之前**运行并完成。如果用户明确表示跳过澄清（例如探索性 spike），可以继续，但必须提醒下游返工风险上升。

执行步骤：

1. 从仓库根目录**仅运行一次** `.specify/scripts/bash/check-prerequisites.sh --json --paths-only`（组合 `--json --paths-only` / `-Json -PathsOnly`）。解析最小 JSON 字段：
   - `FEATURE_DIR`
   - `FEATURE_SPEC`
   - （可选捕获 `IMPL_PLAN`、`TASKS` 供后续链路使用。）
   - 若 JSON 解析失败，终止并提示用户重新运行 `/speckit.specify` 或检查功能分支环境。
   - 对于参数中包含单引号（如 "I'm Groot"），使用转义语法：例如 'I'\''m Groot'（或尽量用双引号："I'm Groot"）。

2. 加载当前规范文件。使用以下分类法进行结构化歧义与覆盖扫描。对每类标记状态：清晰 / 部分 / 缺失。生成内部覆盖图以用于优先级排序（除非不提问，否则不输出原始映射）。

   功能范围与行为：
   - 核心用户目标与成功标准
   - 明确的范围外声明
   - 用户角色/画像区分

   领域与数据模型：
   - 实体、属性、关系
   - 身份与唯一性规则
   - 生命周期/状态迁移
   - 数据规模/容量假设

   交互与体验流程：
   - 关键用户旅程/步骤
   - 错误/空/加载状态
   - 无障碍或本地化说明

   非功能质量属性：
   - 性能（延迟、吞吐目标）
   - 可扩展性（横向/纵向、上限）
   - 可靠性与可用性（可用率、恢复期望）
   - 可观测性（日志、指标、追踪信号）
   - 安全与隐私（认证/授权、数据保护、威胁假设）
   - 合规/监管约束（如有）

   集成与外部依赖：
   - 外部服务/API 及其故障模式
   - 数据导入/导出格式
   - 协议/版本假设

   边界情况与故障处理：
   - 负向场景
   - 限流/节流
   - 冲突解决（如并发编辑）

   约束与权衡：
   - 技术约束（语言、存储、托管）
   - 明确权衡或被否定的替代方案

   术语与一致性：
   - 规范术语表
   - 避免的同义词/废弃术语

   完成信号：
   - 验收标准可测试性
   - 可衡量的完成定义指示

   其他 / 占位符：
   - TODO 标记 / 未决事项
   - 未量化的含糊形容词（"robust"、"intuitive" 等）

   对于状态为 Partial 或 Missing 的类别，生成候选问题机会，除非：
   - 澄清不会实质改变实现或验证策略
   - 更适合延后到规划阶段（内部记录）

3. 生成（内部）澄清问题优先队列（最多 5 个），**不要**一次性输出全部。约束如下：
    - 全会话最多 10 个问题。
    - 每个问题必须可用以下形式回答之一：
       - 简短多选（2–5 个互斥选项），或
       - 单词/短语（显式限制：“答案 <=5 个词”）。
    - 只包含其答案会实质影响架构、数据建模、任务拆分、测试设计、UX 行为、运行就绪或合规验证的问题。
    - 保持类别覆盖平衡：优先覆盖影响高且未解决的类别；不要在高影响问题未解决时连续问两个低影响问题（如安全基线）。
    - 排除已回答、无关紧要的风格偏好或仅计划层面的执行细节（除非阻塞正确性）。
    - 优先减少下游返工风险或避免验收测试失配的澄清。
    - 若未解决类别超过 5 个，按（影响 * 不确定性）选择前 5 个。

4. 顺序提问循环（交互式）：
    - **一次只问一个问题**。
    - 多选题：
       - **分析所有选项**并基于以下因素确定**最合适选项**：
          - 该项目类型的最佳实践
          - 类似实现的常见模式
          - 风险降低（安全、性能、可维护性）
          - 与规范中明确目标/约束的一致性
       - 在顶部显著给出**推荐选项**并说明原因（1-2 句话）。
       - 格式：`**推荐：** 选项 [X] - <reasoning>`
       - 然后用 Markdown 表格列出所有选项：

       | 选项 | 描述 |
       |--------|-------------|
       | A | <Option A description> |
       | B | <Option B description> |
       | C | <Option C description> (如需 D/E，最多 5 个) |
       | Short | 提供不同的简短答案（<=5 词）（仅在允许自由回答时） |

       - 表格后追加：`你可以回复选项字母（如“ A ”），也可以说“yes”或“recommended”接受推荐，或提供你自己的简短答案。`
    - 简短回答题（无明显离散选项）：
       - 基于最佳实践与上下文给出**建议答案**。
       - 格式：`**建议：** <your proposed answer> - <brief reasoning>`
       - 然后输出：`格式：短答案（<=5 个词）。你可以说“yes”或“suggested”接受建议，或给出你自己的答案。`
    - 用户回答后：
       - 若用户回复 "yes"、"recommended" 或 "suggested"，使用之前的推荐/建议作为答案。
       - 否则校验其答案是否匹配某选项或满足 <=5 词约束。
       - 若有歧义，要求快速澄清（仍计入同一问题，不前进）。
       - 满足后记录到工作记忆中（暂不落盘），进入下一问题。
    - 满足以下条件停止继续提问：
       - 关键歧义已提前解决（剩余问题不再必要），或
       - 用户表示完成（"done"、"good"、"no more"），或
       - 已达到 5 个问题。
    - 不得提前透露后续问题。
    - 若一开始没有有效问题，立即报告无关键歧义。

5. 每次接受回答后的集成（增量更新）：
    - 维护内存中的规范表示（启动时加载一次）及原始内容。
    - 会话中的首个答案集成：
       - 确保存在 `## Clarifications` 章节（如无，则按规范模板插入在最高层级背景/概述之后）。
       - 在其下确保存在 `### Session YYYY-MM-DD` 子标题（如无则创建）。
    - 立即追加一行条目：`- Q: <question> → A: <final answer>`。
    - 然后将澄清应用到最合适的章节：
       - 功能歧义 → 更新/新增功能需求条目。
       - 用户交互/角色区分 → 更新用户故事或角色小节（如有）。
       - 数据形态/实体 → 更新数据模型（新增字段、类型、关系），保持排序并简洁说明约束。
       - 非功能约束 → 在非功能/质量属性章节增加/修改可衡量标准（将模糊形容词转为指标或目标）。
       - 边界情况/负向流程 → 在边界情况/错误处理下新增条目（如模板中存在该小节则使用，不存在则创建）。
       - 术语冲突 → 在规范中统一术语；必要时在首次出现处保留原称 `(formerly referred to as "X")` 一次。
    - 若澄清使先前表述失效，应替换旧表述而非重复；不得保留相互矛盾的旧文本。
    - 每次集成后保存规范文件，降低上下文丢失风险（原子覆盖）。
    - 保持格式：不重排无关章节；保持标题层级不变。
    - 每条插入内容保持最小且可测试（避免叙述漂移）。

6. 验证（每次写入后及最终检查）：
   - 澄清会话中每个已接受答案恰好对应一条条目（无重复）。
   - 总问题数（已接受）≤ 5。
   - 更新章节中不应保留已被解答的模糊占位符。
   - 不保留矛盾的旧说法（移除失效替代项）。
   - Markdown 结构有效；唯一新增标题允许：`## Clarifications`、`### Session YYYY-MM-DD`。
   - 术语一致：所有更新章节使用相同规范术语。

7. 将更新后的规范写回 `FEATURE_SPEC`。

8. 汇报完成（提问循环结束或提前终止后）：
   - 已提问并回答的问题数量。
   - 更新后的规范路径。
   - 修改的章节（列出名称）。
   - 覆盖摘要表，列出每个分类的状态：已解决（此前为部分/缺失且已处理）、延后（超出问题配额或更适合规划阶段）、清晰（原本就充分）、未解决（仍为部分/缺失且影响低）。
   - 若存在未解决或延后，建议是否继续 `/speckit.plan` 或稍后再跑 `/speckit.clarify`。
   - 建议的下一条命令。

行为规则：

- 若未发现有意义的歧义（或潜在问题影响很低），回复：“未发现值得正式澄清的关键歧义。”并建议继续。
- 若规范文件缺失，提示用户先运行 `/speckit.specify`（不要在这里新建规范）。
- 总提问数不得超过 5（单个问题的澄清回合不计为新问题）。
- 除非缺失阻塞功能明确性，否则避免询问技术栈细节。
- 尊重用户提前终止信号（"stop"、"done"、"proceed"）。
- 若因覆盖充分而未提问，输出简洁覆盖摘要（全部清晰），并建议继续。
- 若达到配额仍存在高影响未解类别，在“延后”中明确标注并说明理由。

优先级上下文：$ARGUMENTS

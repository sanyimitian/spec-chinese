---
description: 基于用户需求为当前功能生成定制清单。
---

## 清单目的："英文需求的单元测试"

**关键概念**：清单是**需求写作的单元测试**——用于验证某一领域需求的质量、清晰度与完整性。

**不是用于验证/测试实现**：

- ❌ 不是“验证按钮能正确点击”
- ❌ 不是“测试错误处理可用”
- ❌ 不是“确认 API 返回 200”
- ❌ 不是检查实现是否与规范一致

**用于验证需求质量**：

- ✅ "是否为所有卡片类型定义了视觉层级要求？"（完整性）
- ✅ "对‘突出展示’是否用具体尺寸/位置量化？"（清晰度）
- ✅ "所有交互元素的悬停状态要求是否一致？"（一致性）
- ✅ "是否为键盘导航定义了无障碍要求？"（覆盖）
- ✅ "当 logo 图片加载失败时是否定义了行为？"（边界情况）

**类比**：如果规范是用英文写的代码，清单就是它的单元测试套件。你要测试的是需求是否写得清楚、完整、无歧义，且可实施——而不是实现是否工作正常。

## 用户输入

```text
$ARGUMENTS
```

在继续之前你**必须**先考虑用户输入（如果不为空）。

## 执行步骤

1. **准备**：从仓库根目录运行 `.specify/scripts/bash/check-prerequisites.sh --json` 并解析 JSON 中的 FEATURE_DIR 和 AVAILABLE_DOCS 列表。
   - 所有路径必须是绝对路径。
   - 对于参数中包含单引号（如 "I'm Groot"），使用转义语法：例如 'I'\''m Groot'（或尽量用双引号："I'm Groot"）。

2. **澄清意图（动态）**：派生最多三个初始上下文澄清问题（不要用预设题库）。它们必须：
   - 基于用户措辞 + 从 spec/plan/tasks 中提取的信号生成
   - 只询问会实质改变清单内容的信息
   - 如果 `$ARGUMENTS` 已明确，则逐条跳过
   - 宁可精确，避免泛泛

   生成算法：
   1. 提取信号：功能领域关键词（如 auth、latency、UX、API）、风险指示（"critical"、"must"、"compliance"）、干系人提示（"QA"、"review"、"security team"）、明确交付物（"a11y"、"rollback"、"contracts"）。
   2. 将信号聚类为候选关注域（最多 4 个），按相关性排序。
   3. 若未明确，识别可能的受众与时机（作者、评审、QA、发布）。
   4. 识别缺失维度：范围宽度、深度/严格度、风险侧重、排除边界、可量化验收标准。
   5. 从以下原型中形成问题：
      - 范围精炼（如“应包含与 X、Y 的集成触点，还是仅限本地模块正确性？”）
      - 风险优先级（如“以下风险区域中哪些应设置为必过门槛？”）
      - 深度标定（如“这是轻量预提交清单还是正式发布门禁？”）
      - 受众框定（如“供作者自查还是 PR 同行评审使用？”）
      - 边界排除（如“本轮是否明确排除性能调优项？”）
      - 场景类型缺口（如“未检测到恢复流程——回滚/部分失败是否在范围内？”）

   问题格式规则：
   - 若给出选项，生成紧凑表格：列为 选项 | 候选 | 重要性
   - 选项最多 A–E；如自由回答更清晰则不输出表格
   - 不要求用户复述已说内容
   - 避免臆测类别（不凭空捏造）。若不确定，明确询问：“请确认 X 是否在范围内。”

   无法互动时的默认值：
   - 深度：标准
   - 受众：若与代码相关则为评审（PR），否则为作者
   - 重点：相关性最高的 2 个聚类

   输出问题（标记 Q1/Q2/Q3）。回答后：若仍有 ≥2 个场景类型（备选 / 异常 / 恢复 / 非功能领域）不明确，**可**追加最多两个定向追问（Q4/Q5），每个附一行理由（如“恢复路径风险未解决”）。总问题不超过 5 个。若用户明确拒绝更多，停止追问。

3. **理解用户请求**：合并 `$ARGUMENTS` 与澄清答案：
   - 推导清单主题（如 security、review、deploy、ux）
   - 汇总用户明确要求的必备项
   - 将关注点映射到分类骨架
   - 从 spec/plan/tasks 推断缺失上下文（不得臆造）

4. **加载功能上下文**：读取 FEATURE_DIR：
   - spec.md：需求与范围
   - plan.md（若存在）：技术细节、依赖
   - tasks.md（若存在）：实现任务

   **上下文加载策略**：
   - 只加载与当前关注域相关的必要部分（避免全文倾倒）
   - 长段落优先总结为简洁场景/需求要点
   - 采用渐进式披露：仅在发现缺口时追加读取
   - 若源文档很长，生成中间摘要而非嵌入原文

5. **生成清单** - 创建“需求单元测试”：
   - 如不存在则创建 `FEATURE_DIR/checklists/` 目录
   - 生成唯一清单文件名：
     - 使用基于领域的简短描述名（如 `ux.md`、`api.md`、`security.md`）
     - 格式：`[domain].md`
     - 若文件已存在，则追加到现有文件
   - 编号从 CHK001 起连续递增
   - 每次 `/speckit.checklist` 运行都会创建新文件（绝不覆盖已有清单）

   **核心原则 - 测需求，不测实现**：
   每条清单必须评估需求文本本身的：
   - **完整性**：必要需求是否齐全
   - **清晰度**：需求是否明确具体
   - **一致性**：需求之间是否一致
   - **可衡量性**：能否客观验证
   - **覆盖性**：场景/边界情况是否覆盖

   **分类结构** - 按需求质量维度分组：
   - **需求完整性**（是否记录了所有必要需求？）
   - **需求清晰度**（是否具体且无歧义？）
   - **需求一致性**（是否不存在冲突？）
   - **验收标准质量**（成功标准是否可衡量？）
   - **场景覆盖**（所有流程/场景是否覆盖？）
   - **边界情况覆盖**（边界条件是否定义？）
   - **非功能需求**（性能、安全、无障碍等是否说明？）
   - **依赖与假设**（是否记录并验证？）
   - **歧义与冲突**（需要澄清的问题）

   **如何写清单项 - “英文单元测试”**：

   ❌ **错误**（测试实现）：
   - "验证落地页展示 3 张剧集卡片"
   - "测试桌面端悬停状态"
   - "确认点击 logo 返回首页"

   ✅ **正确**（测试需求质量）：
   - "是否明确了精选剧集的数量和布局？" [Completeness]
   - "对‘突出展示’是否用具体尺寸/位置量化？" [Clarity]
   - "所有交互元素的悬停状态要求是否一致？" [Consistency]
   - "是否为所有交互 UI 定义了键盘导航要求？" [Coverage]
   - "当 logo 图片加载失败时是否指定了回退行为？" [Edge Cases]
   - "是否定义了异步剧集数据的加载状态？" [Completeness]
   - "规范是否定义了竞争性 UI 元素的视觉层级？" [Clarity]

   **条目结构**：
   每条应遵循以下模式：
   - 问句形式，检查需求质量
   - 聚焦“写了什么/没写什么”
   - 方括号标明质量维度 [Completeness/Clarity/Consistency/etc.]
   - 检查已有需求时引用规范段落 `[Spec §X.Y]`
   - 检查缺失需求时使用 `[Gap]` 标记

   **按质量维度示例**：

   完整性：
   - "是否为所有 API 失败模式定义了错误处理需求？ [Gap]"
   - "是否为所有交互元素指定了无障碍要求？ [Completeness]"
   - "是否定义了响应式布局的移动端断点要求？ [Gap]"

   清晰度：
   - "‘fast loading’ 是否用具体阈值量化？ [Clarity, Spec §NFR-2]"
   - "‘related episodes’ 的选择标准是否明确？ [Clarity, Spec §FR-5]"
   - "‘prominent’ 是否用可衡量的视觉属性定义？ [Ambiguity, Spec §FR-4]"

   一致性：
   - "各页面导航需求是否一致？ [Consistency, Spec §FR-10]"
   - "落地页与详情页的卡片组件需求是否一致？ [Consistency]"

   覆盖性：
   - "是否定义了零状态场景（无剧集）的需求？ [Coverage, Edge Case]"
   - "是否覆盖并发用户交互场景的需求？ [Coverage, Gap]"
   - "是否指定了部分数据加载失败的需求？ [Coverage, Exception Flow]"

   可衡量性：
   - "视觉层级要求是否可测/可验证？ [Acceptance Criteria, Spec §FR-1]"
   - "‘balanced visual weight’ 是否可客观验证？ [Measurability, Spec §FR-2]"

   **场景分类与覆盖**（聚焦需求质量）：
   - 检查是否存在：主流程、备选、异常/错误、恢复、非功能场景
   - 对每类场景发问：“是否为 [场景类型] 的需求完整、清晰且一致？”
   - 若场景缺失：“[场景类型] 需求是否被有意排除或缺失？ [Gap]”
   - 存在状态变更时纳入韧性/回滚：“迁移失败时是否定义回滚需求？ [Gap]”

   **可追溯性要求**：
   - 最低要求：≥80% 条目必须包含至少一个可追溯引用
   - 每条应引用：规范段落 `[Spec §X.Y]`，或使用 `[Gap]`、`[Ambiguity]`、`[Conflict]`、`[Assumption]`
   - 若无 ID 体系：“是否建立需求与验收标准的 ID 方案？ [Traceability]”

   **暴露并解决问题**（需求质量问题）：
   针对需求本身提出问题：
   - 歧义："术语 'fast' 是否有具体指标？ [Ambiguity, Spec §NFR-1]"
   - 冲突："§FR-10 与 §FR-10a 的导航需求是否冲突？ [Conflict]"
   - 假设："'always available podcast API' 的假设是否已验证？ [Assumption]"
   - 依赖："外部 podcast API 需求是否文档化？ [Dependency, Gap]"
   - 缺失定义："'visual hierarchy' 是否有可衡量的定义？ [Gap]"

   **内容合并**：
   - 软上限：候选条目 > 40 时按风险/影响优先
   - 合并检查同一需求维度的近似重复项
   - 若低影响边界情况 > 5，可合并为一项：“是否覆盖了边界情况 X、Y、Z 的需求？ [Coverage]”

   **🚫 绝对禁止** - 这些会把它变成实现测试：
   - ❌ 任意以 "Verify"、"Test"、"Confirm"、"Check" 开头且描述实现行为的条目
   - ❌ 引用代码执行、用户动作、系统行为
   - ❌ "Displays correctly"、"works properly"、"functions as expected"
   - ❌ "Click"、"navigate"、"render"、"load"、"execute"
   - ❌ 测试用例、测试计划、QA 流程
   - ❌ 实现细节（框架、API、算法）

   **✅ 必需模式** - 这些测试需求质量：
   - ✅ "是否为 [场景] 定义/说明/记录了 [需求类型]？"
   - ✅ "[模糊术语] 是否用具体标准量化/澄清？"
   - ✅ "[章节 A] 与 [章节 B] 的需求是否一致？"
   - ✅ "[需求] 是否可客观测量/验证？"
   - ✅ "[边界情况/场景] 是否在需求中被覆盖？"
   - ✅ "规范是否定义了 [缺失项]？"

6. **结构引用**：按照 `.specify/templates/checklist-template.md` 的规范输出标题、元信息、分类标题与 ID 格式。若模板不可用，使用：H1 标题、purpose/created 元信息行、`##` 分类标题，包含 `- [ ] CHK### <requirement item>` 行，并从 CHK001 全局递增。

7. **汇报**：输出创建的清单完整路径、条目数，并提醒用户每次运行会创建新文件。总结：
   - 关注域
   - 问题数量
   - 需求覆盖范围

上下文：$ARGUMENTS

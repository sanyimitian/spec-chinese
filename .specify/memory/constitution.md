---
description: 在任务生成后，对 spec.md、plan.md、tasks.md 进行非破坏性的一致性与质量分析。
---

## 用户输入

```text
$ARGUMENTS
```

在继续之前你**必须**先考虑用户输入（如果不为空）。

## 目标

在实施之前，识别三份核心工件（`spec.md`、`plan.md`、`tasks.md`）之间的不一致、重复、歧义与未充分说明的内容。此命令**必须**在 `/speckit.tasks` 成功生成完整 `tasks.md` 之后运行。

## 操作约束

**严格只读**：**不得**修改任何文件。输出结构化分析报告。可提供可选的修复方案（用户必须显式批准后，才可手动触发任何后续编辑命令）。

**宪法权威**：项目宪法（`.specify/memory/constitution.md`）在本分析范围内**不可妥协**。与宪法冲突即为 CRITICAL，必须调整 spec、plan 或 tasks；不得稀释、重新解释或默默忽略原则。如需更改原则，必须在 `/speckit.analyze` 之外另行显式更新宪法。

## 执行步骤

### 1. 初始化分析上下文

从仓库根目录运行一次 `.specify/scripts/bash/check-prerequisites.sh --json --require-tasks --include-tasks`，解析 JSON 中的 FEATURE_DIR 与 AVAILABLE_DOCS。派生绝对路径：

- SPEC = FEATURE_DIR/spec.md
- PLAN = FEATURE_DIR/plan.md
- TASKS = FEATURE_DIR/tasks.md

如果缺少任何必需文件，输出错误并中止（提示用户运行缺失的前置命令）。
对于参数中包含单引号（如 "I'm Groot"），使用转义语法：例如 'I'\''m Groot'（或尽量用双引号："I'm Groot"）。

### 2. 加载工件（渐进式披露）

仅加载每个工件所需的最小上下文：

**来自 spec.md：**

- 概述/背景
- 功能需求
- 非功能需求
- 用户故事
- 边界情况（如有）

**来自 plan.md：**

- 架构/技术栈选择
- 数据模型引用
- 阶段
- 技术约束

**来自 tasks.md：**

- 任务 ID
- 描述
- 阶段分组
- 并行标记 [P]
- 引用的文件路径

**来自宪法：**

- 加载 `.specify/memory/constitution.md` 以进行原则校验

### 3. 构建语义模型

创建内部表示（输出中不包含原始工件）：

- **需求清单**：每条功能与非功能需求，用稳定键（根据祈使短语生成 slug；如 "User can upload file" → `user-can-upload-file`）
- **用户故事/动作清单**：离散的用户动作与验收标准
- **任务覆盖映射**：将每个任务映射到一个或多个需求或故事（通过关键词/显式引用模式，如 ID 或关键短语推断）
- **宪法规则集**：提取原则名称与 MUST/SHOULD 规范性陈述

### 4. 发现检查（高信号分析）

聚焦高价值发现。最多 50 条；其余汇总到溢出摘要。

#### A. 重复检测

- 识别近似重复需求
- 标记较低质量表述以合并

#### B. 歧义检测

- 标记缺少可量化标准的模糊形容词（fast, scalable, secure, intuitive, robust）
- 标记未解决的占位符（TODO, TKTK, ???, `<placeholder>` 等）

#### C. 未充分说明

- 含动词但缺少对象或可衡量结果的需求
- 用户故事缺少验收标准对齐
- 引用了 spec/plan 中未定义的文件或组件的任务

#### D. 宪法一致性

- 任何与 MUST 原则冲突的需求或计划元素
- 缺失宪法要求的章节或质量门禁

#### E. 覆盖缺口

- 没有任何关联任务的需求
- 没有映射到需求/故事的任务
- 非功能需求未反映到任务中（例如性能、安全）

#### F. 不一致

- 术语漂移（同一概念在文件中被不同命名）
- 计划中引用的数据实体在规范中缺失（或反之）
- 任务顺序矛盾（如在未注明依赖的情况下先做集成任务再做基础搭建）
- 需求冲突（如一处要求 Next.js，另一处指定 Vue）

### 5. 严重级别

使用以下启发式进行排序：

- **CRITICAL**：违反宪法 MUST、缺少核心规范工件、或零覆盖且阻塞基础功能的需求
- **HIGH**：重复或冲突需求、含糊的安全/性能属性、不可测试的验收标准
- **MEDIUM**：术语漂移、非功能任务覆盖缺失、边界情况未充分说明
- **LOW**：样式/措辞改进、对执行顺序无影响的轻微冗余

### 6. 输出精简分析报告

输出 Markdown 报告（不写文件），结构如下：

## 规范分析报告

| ID | 类别 | 严重级别 | 位置 | 摘要 | 建议 |
|----|----------|----------|-------------|---------|----------------|
| A1 | 重复 | HIGH | spec.md:L120-134 | 两条需求过于相似 ... | 合并表述，保留更清晰版本 |

（每条发现占一行；生成稳定 ID，前缀为类别首字母。）

**覆盖摘要表：**

| 需求键 | 有任务？ | 任务 ID | 备注 |
|-----------------|-----------|----------|-------|

**宪法一致性问题：**（如有）

**未映射任务：**（如有）

**统计：**

- 总需求数
- 总任务数
- 覆盖率 %（至少有 1 个任务的需求）
- 歧义数量
- 重复数量
- 严重问题数量

### 7. 提供下一步行动

在报告末尾输出简洁的下一步行动：

- 若存在 CRITICAL：建议在 `/speckit.implement` 前先修复
- 仅有 LOW/MEDIUM：可继续，但给出改进建议
- 给出明确命令建议：如“运行 /speckit.specify 以完善”、“运行 /speckit.plan 以调整架构”、“手动编辑 tasks.md 为 'performance-metrics' 增加覆盖”。

### 8. 提供修复选项

询问用户：“是否需要我为前 N 个问题提供具体修复改动建议？”（不要自动应用。）

## 操作原则

### 上下文效率

- **最小高信号 token**：聚焦可执行发现，而非穷尽文档
- **渐进式披露**：增量加载工件；不要倾倒全部内容
- **高效输出**：发现表限制为 50 行；其余汇总
- **确定性结果**：未变化时重复运行应产生一致的 ID 与统计

### 分析指南

- **绝不修改文件**（只读分析）
- **绝不臆造缺失章节**（如缺失则如实报告）
- **优先宪法违规**（一律 CRITICAL）
- **重实例不求全**（引用具体实例，不写泛泛规则）
- **零问题要优雅**（输出成功报告 + 覆盖统计）

## 上下文

$ARGUMENTS
